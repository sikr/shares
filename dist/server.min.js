!function(){var a,b=require("fs"),c=require("sqlite3").verbose(),d=require("sqlite3-transactions").TransactionDatabase;exports.open=function(b){a=new d(new c.Database(b))},exports.clear=function(b){a.serialize(function(){var c,d;for(c in b)d=a.prepare("DELETE FROM "+b[c].name),d.run();d.finalize()})},exports.deleteFromDisk=function(a){var c=b.existsSync(a);c&&b.unlinkSync(a)},exports.createTables=function(b,c){var d;a.serialize(function(){var b;for(b in c)d=a.prepare("CREATE TABLE "+c[b].name+" ("+c[b].sql+")"),d.run();d.finalize()})},exports.fillTables=function(b){a.serialize(function(){var c,d,e,f,g,h,i,j=function(){console.log(this.sql)};for(d in b)if(b[d].data.length>0){i=[],e="INSERT INTO "+b[d].name+" VALUES (";for(f in b[d].data[0])i.push("?");for(e+=i.join(",")+")",c=a.prepare(e),f=0;f<b[d].data.length;f++){h=[];for(g in b[d].data[f])h.push(b[d].data[f][g]);console.log(c.sql+" "+JSON.stringify(h)+"("+h.length+")"),c.simon=JSON.stringify(h),c.run(h,j)}c.finalize()}})},exports.getTables=function(){var b=a.prepare("SELECT * FROM sqlite_master");b.all(function(a,b){if(a)console.log(a);else;})},exports.close=function(){a.serialize(function(){a.close()})},exports.test=function(){var b;b=a.prepare('SELECT   shares.id AS id,                        shares.name AS name,                    positions.count AS count,               quotes.close AS close,                  quotes.date AS date            FROM     shares, positions, quotes      WHERE    shares.id=quotes.share_id      AND      quotes.date=date("2014-10-30") AND      positions.share_id=shares.id   ORDER BY shares.name                    '),b.all(function(a,b){if(a)console.log(a);else{sum=0;for(var c in b)b[c].sum=(b[c].close*b[c].count).toFixed(2),console.log(JSON.stringify(b[c])),sum+=b[c].close*b[c].count;console.log(sum)}})},exports.getDepots=function(b){var c;c=a.prepare("SELECT   id,                  name,                description FROM     depots      ORDER BY id          "),c.all(function(a,c){a?console.log(a):b(c)})},exports.getDepot=function(b,c){var d;d=a.prepare("SELECT   positions_id  FROM     depot         WHERE    depot_id=?    ORDER BY positions_id  "),d.all(b,function(a,b){a?console.log(a):c(b)})},exports.getPositions=function(b,c){var d=a.prepare("SELECT                                                positions.symbol,                            positions.count,                             positions.buying_price,                      positions.buying_date,                       positions.selling_price,                     positions.selling_date,                      shares.id,                                   shares.symbol,                               shares.name,                                 shares.isin,                                 shares.wkn                          FROM     depots, depot, positions, shares    WHERE    depot.depot_id=?                    AND      depots.id=depot.depot_id            AND      depot.positions_id=positions.id     AND      positions.share_id=shares.id        GROUP BY shares.id                           ORDER BY shares.name                         ");d.all(b,function(a,b){a?console.log(a):c(b)})},exports.getQuotes=function(b,c){var d=a.prepare('SELECT   strftime("%s", quotes.date) * 1000 AS date,                                    quotes.close AS close                                                 FROM     shares, quotes                                                        WHERE    shares.symbol=?                                                       AND      strftime("%s", quotes.date) > strftime("%s", date("now", "-3 years")) AND      quotes.share_id=shares.id                                             ORDER BY quotes.date                                                           ');d.all(b,function(a,b){var d,e=[];if(a)console.log(a);else{for(d in b)e.push([b[d].date,b[d].close]);c(e)}})},exports.getShare=function(b,c){var d=a.prepare("SELECT *       FROM   shares  WHERE  symbol=?");d.all(b,function(a,b){c(b)})},exports.dumpFiles=function(){var c,d,e,f,g,h=b.readdirSync("../data/"),i=[],j=0,k=0;f=a.prepare("SELECT shares.id AS id,               shares.name AS name,           shares.symbol AS symbol FROM   shares                  "),f.all(function(b,l){a.beginTransaction(function(a,b){var m,n;for(m in l)i[l[m].id]=l[m].symbol;for(n in h){c=h[n].split("_")[0],d=-1;for(m in i)i[m]==c&&(d=m);if(d>-1){console.log("Processing file "+h[n]+", Symbol "+c+", Id "+d),e=require("../data/"+h[n]).query.results.quote,j=0,g=0;for(m in e)f=b.prepare("INSERT INTO quotes VALUES (NULL,?,date(?),?,?,?,?,?,?)"),f.run(d,e[m].Date,e[m].Open,e[m].High,e[m].Low,e[m].Close,e[m].Volume,e[m].Adj_Close),g+=parseFloat(e[m].Close),j++,k++;f.finalize(),console.log("  -> "+j+" entries inserted, sum="+g.toFixed(2))}}b.commit(function(a){console.log(a?"commit failed":"commit successful")}),console.log("total count: "+k)})})}}(),function(){function a(){g.existsSync(m+n)?h.clear(x):g.existsSync(m)||(g.mkdirSync(m),h.open(m+n),h.createTables(m+n,x)),h.fillTables(x),h.dumpFiles()}function b(){j.use("/shares",i.static("../")),j.use(function(a,b,c){console.log("request:"+a.url),c()}),j.get("/depots",function(a,b){b.header("Access-Control-Allow-Origin","*"),b.header("foo","bar"),h.getDepots(function(a){b.send(JSON.stringify(a))})}),j.get("/depot",function(a,b){var c=a.url.substr(10);b.header("Access-Control-Allow-Origin","*"),b.header("foo","bar"),h.getDepot(c,function(a){b.send(JSON.stringify(a))})}),j.get("/positions",function(a,b){var c=a.url.substr(14);b.header("Access-Control-Allow-Origin","*"),b.header("foo","bar"),h.getPositions(c,function(a){b.send(JSON.stringify(a))})}),j.get("/quotes",function(a,b){var c=a.url.substr(15);b.header("Access-Control-Allow-Origin","*"),b.header("foo","bar"),h.getQuotes(c,function(a){b.send(JSON.stringify(a))})}),j.get("/share",function(a,b){var c=a.url.substr(14);b.header("Access-Control-Allow-Origin","*"),b.header("foo","bar"),h.getShare(c,function(a){b.send(JSON.stringify(a))})});var a=j.listen(7781,function(){var b=a.address().address,c=a.address().port;console.log("Example app listening at http://%s:%s",b,c)}),b=k.listen(7780,function(){var a=b.address().address,c=b.address().port;console.log("Example app listening at http://%s:%s",a,c)});l.on("connection",function(a){console.log("websocket successfully connected"),a.on("disconnect",function(){console.log("websocket disconnected")})})}var c,d,e,f,g=(require("util"),require("fs")),h=(require("sqlite3").verbose(),require("./db")),i=require("express"),j=i(),k=require("http").Server(j),l=require("socket.io")(k),m="../db/",n="shares.sqlite",o="id            INTEGER PRIMARY KEY,              name          TEXT,                             description   TEXT                              ",p="depot_id      INTEGER,                          positions_id                                    ",q="id            INTEGER PRIMARY KEY,              symbol        TEXT,                             isin          TEXT,                             wkn           TEXT,                             name          TEXT                              ",r="id            INTEGER PRIMARY KEY,              share_id      INTEGER,                          symbol        TEXT,                             exchange      TEXT,                             currency      TEXT,                             count         INTEGER,                          buying_price  REAL,                             buying_date   INTEGER,                          selling_price REAL,                             selling_date  INTEGER                           ",s="id            INTEGER PRIMARY KEY AUTOINCREMENT,share_id      INTEGER,                          date          INTEGER,                          open          REAL,                             high          REAL,                             low           REAL,                             close         REAL,                             volume        INTEGER,                          adj_close     REAL                              ",t=require("../json/depots.json"),u=require("../json/depot.json"),v=require("../json/shares.json"),w=require("../json/positions.json");g.existsSync("../json/private_depots.json")&&(c=require("../json/private_depots.json"),f=t.concat(c),t=f),g.existsSync("../json/private_depot.json")&&(d=require("../json/private_depot.json"),f=u.concat(d),u=f),g.existsSync("../json/private_positions.json")&&(e=require("../json/private_positions.json"),f=w.concat(e),w=f);var x=[{name:"depots",sql:o,data:t},{name:"depot",sql:p,data:u},{name:"shares",sql:q,data:v},{name:"positions",sql:r,data:w},{name:"quotes",sql:s,data:[]}];h.open(m+n),h.getTables(),"-c"==process.argv[2]||"--create"==process.argv[2]?(console.time("Create Datebase"),a(),console.timeEnd("Create Datebase")):b()}();